{% extends "base.html" %}
{% set page_title = "Article Viewer" %}
{% set page_subtitle = "Browse all processed and cached articles" %}

{% block content %}

<div class="tabs is-boxed">
  <ul>
    <li class="is-active" id="tab-processed" onclick="switchTab('processed')">
      <a>
        <span class="icon is-small"><i class="mdi mdi-check-circle-outline"></i></span>
        <span>Processed ({{ processed|length }})</span>
      </a>
    </li>
    <li id="tab-skipped" onclick="switchTab('skipped')">
      <a>
        <span class="icon is-small"><i class="mdi mdi-file-hidden"></i></span>
        <span>Skipped / Cached ({{ skipped|length }})</span>
      </a>
    </li>
  </ul>
</div>

<div id="content-processed">
    {% if processed %}
    <div class="table-container">
        <table class="table is-fullwidth is-striped is-hoverable">
            <thead>
                <tr>
                    <th style="width: 30%;">Article</th>
                    <th>Analysis & Reasoning</th>
                    <th style="width: 15%;">Scores</th>
                </tr>
            </thead>
            <tbody>
                {% for article in processed %}
                <tr>
                    <td>
                        <p class="title is-6 mb-1">
                            <a href="{{ article.url }}" target="_blank" class="has-text-link">
                                {{ article.title }}
                            </a>
                        </p>
                        <p class="is-size-7 has-text-grey mb-2">
                            {{ article.source }} · {{ article.published }}
                        </p>
                        <div class="tags">
                            {% for tag in article.topic_tags %}
                            <span class="tag is-light is-info">{{ tag }}</span>
                            {% endfor %}
                        </div>
                    </td>
                    <td>
                        <p class="is-size-6 mb-2">{{ article.summary_text }}</p>
                        {% if article.relevance_reasoning %}
                        <article class="message is-small is-primary is-light">
                            <div class="message-body py-2 px-3">
                                <strong>Why:</strong> {{ article.relevance_reasoning }}
                            </div>
                        </article>
                        {% endif %}

                        {% if article.history %}
                        <div class="mt-3">
                            <details>
                                <summary class="is-size-7 has-text-grey" style="cursor: pointer;">
                                    <strong>History</strong> ({{ article.history|length }} updates)
                                </summary>
                                <div class="content is-size-7 mt-2 pl-2" style="border-left: 2px solid #dbdbdb;">
                                    {% for event in article.history %}
                                        <div class="mb-2">
                                            <span class="has-text-grey-light">{{ event.timestamp[:16].replace('T', ' ') }}</span>
                                            {% if event.changes %}
                                                {% for field, change in event.changes.items() %}
                                                    {% if field == 'relevance_score' %}
                                                        <span class="tag is-white is-small" style="border: 1px solid #dbdbdb;">
                                                            R: <strong>{{ change['from'] }}</strong> → <strong>{{ change['to'] }}</strong>
                                                        </span>
                                                    {% elif field == 'impact_score' %}
                                                        <span class="tag is-white is-small" style="border: 1px solid #dbdbdb;">
                                                            I: <strong>{{ change['from'] }}</strong> → <strong>{{ change['to'] }}</strong>
                                                        </span>
                                                    {% elif field == 'status' %}
                                                        <span class="tag is-light is-small">
                                                            Status: {{ change['from'] }} → {{ change['to'] }}
                                                        </span>
                                                    {% elif field == 'relevance_reasoning' %}
                                                        <div class="mt-1 has-text-grey-dark is-italic" style="border-left: 2px solid #ddd; padding-left: 0.5rem;">
                                                            "{{ change['to'] }}"
                                                        </div>
                                                    {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <span class="is-italic has-text-grey">Reappraised (no score changes)</span>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </details>
                        </div>
                        {% endif %}
                    </td>
                    <td>
                        <div class="field is-grouped is-grouped-multiline">
                            <div class="control">
                                <span class="tag is-medium {% if article.relevance_score >= 7 %}is-success{% elif article.relevance_score >= 4 %}is-warning{% else %}is-light{% endif %}" title="Local Relevance Score">
                                    R: {{ article.relevance_score }}
                                </span>
                            </div>
                            <div class="control">
                                <span class="tag is-medium {% if article.impact_score >= 7 %}is-danger{% elif article.impact_score >= 4 %}is-warning{% else %}is-light{% endif %}" title="Local Impact Score">
                                    I: {{ article.impact_score }}
                                </span>
                            </div>
                        </div>

                        <!-- Status Actions -->
                        <div class="buttons has-addons are-small mb-3">
                            <form method="post" action="{{ url_for('articles.update_article_status', article_id=article.id) }}">
                                <input type="hidden" name="status" value="High">
                                <button class="button {% if article.status == 'High' %}is-selected is-success{% endif %}" title="Set High" {% if article.status == 'High' %}disabled{% endif %}>H</button>
                            </form>
                            <form method="post" action="{{ url_for('articles.update_article_status', article_id=article.id) }}">
                                <input type="hidden" name="status" value="Medium">
                                <button class="button {% if article.status == 'Medium' %}is-selected is-warning{% endif %}" title="Set Medium" {% if article.status == 'Medium' %}disabled{% endif %}>M</button>
                            </form>
                            <form method="post" action="{{ url_for('articles.update_article_status', article_id=article.id) }}">
                                <input type="hidden" name="status" value="Low">
                                <button class="button {% if article.status == 'Low' %}is-selected is-light{% endif %}" title="Set Low" {% if article.status == 'Low' %}disabled{% endif %}>L</button>
                            </form>
                             <form method="post" action="{{ url_for('articles.update_article_status', article_id=article.id) }}">
                                <input type="hidden" name="status" value="Dismissed">
                                <button class="button {% if article.status == 'Dismissed' %}is-selected is-grey{% endif %}" title="Dismiss" {% if article.status == 'Dismissed' %}disabled{% endif %}><i class="mdi mdi-close"></i></button>
                            </form>
                            <form method="post" action="{{ url_for('articles.reappraise_article', article_id=article.id) }}" onsubmit="if(confirm('Re-run analysis with current context? This may take a moment.')) { this.querySelector('button').classList.add('is-loading'); return true; } return false;">
                                <button class="button is-info is-light ml-2" title="Reappraise / Re-analyze">
                                    <span class="icon is-small"><i class="mdi mdi-refresh"></i></span>
                                </button>
                            </form>
                        </div>
                        
                        {% if article.verification %}
                        <div class="mt-3 pt-2 is-size-7" style="border-top: 1px solid #dbdbdb;">
                            <p class="heading mb-1 has-text-grey">
                                <i class="mdi mdi-shield-check"></i> Verification
                            </p>
                            <div class="is-flex is-align-items-center mb-1">
                                <span class="tag is-small {% if article.verification.remote_score >= 7 %}is-success{% elif article.verification.remote_score >= 4 %}is-warning{% else %}is-light{% endif %}" title="Remote Score">
                                    Score: {{ article.verification.remote_score }}
                                </span>
                                {% if article.verification.flagged %}
                                <span class="tag is-small is-danger ml-1" title="Significant Mismatch Detected">
                                    <i class="mdi mdi-alert"></i>
                                </span>
                                {% endif %}
                            </div>
                            {% if article.verification.remote_reasoning %}
                            <p class="has-text-grey-dark" style="line-height: 1.2;">
                                <em>"{{ article.verification.remote_reasoning }}"</em>
                            </p>
                            {% endif %}
                        </div>
                        {% endif %}

                        <div class="mt-2">
                             <a class="button is-small is-text" href="{{ url_for('articles.edit_tags', article_id=article.id) }}">
                                Edit Details
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="notification is-info is-light">
        No processed articles found in the database. Run the pipeline to ingest news.
    </div>
    {% endif %}
</div>

<div id="content-skipped" class="is-hidden">
    <div class="notification is-light mb-4">
        These articles were fetched and cached but <strong>not processed</strong> (likely filtered out by keywords or duplicates).
    </div>
    {% if skipped %}
    <div class="table-container">
        <table class="table is-fullwidth is-striped is-hoverable">
            <thead>
                <tr>
                    <th>Article</th>
                    <th>Summary Preview</th>
                    <th>Published</th>
                    <th>Cached</th>
                </tr>
            </thead>
            <tbody>
                {% for article in skipped %}
                <tr>
                    <td>
                        <p class="has-text-weight-medium">
                            <a href="{{ article.url }}" target="_blank">{{ article.title }}</a>
                        </p>
                        <p class="is-size-7 has-text-grey">{{ article.source }}</p>
                    </td>
                    <td class="is-size-7">
                        {{ article.summary|truncate(150) }}
                    </td>
                    <td class="is-size-7 has-text-grey">
                        {{ article.published }}
                    </td>
                    <td class="is-size-7 has-text-grey-light">
                        <!-- Timestamp to readable date -->
                        {% if article.timestamp %}
                        <span class="cached-time" data-ts="{{ article.timestamp }}"></span>
                        {% else %}
                        —
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <p>No skipped articles in cache.</p>
    {% endif %}
</div>

<script>
    function switchTab(tabName) {
        // Tabs
        document.querySelectorAll('.tabs li').forEach(li => li.classList.remove('is-active'));
        document.getElementById('tab-' + tabName).classList.add('is-active');
        
        // Content
        document.getElementById('content-processed').classList.add('is-hidden');
        document.getElementById('content-skipped').classList.add('is-hidden');
        document.getElementById('content-' + tabName).classList.remove('is-hidden');
    }

    // Format timestamps
    document.querySelectorAll('.cached-time').forEach(span => {
        const ts = parseFloat(span.dataset.ts);
        if (ts) {
            span.innerText = new Date(ts * 1000).toLocaleString();
        }
    });
</script>

{% endblock %}
